/*!
 * WEUI For mainui
 * https://www.kdc.xyz/
 * @author:迷糊的阿多
 */
$(document).ready(function() {
	//顶部导航栏滚动固定
	$(".tab-container").scroll(function(){
		var top = $(this).scrollTop();
		if (top <= 32) {
			$(".header-index").removeClass("bg_header");
		} else {
			$(".header-index").addClass("bg_header");
		}
	});
	
	//底部固定导航栏切换操作
	var flag = $("body").attr("id");
	var $footer = $(".footer-tabbar");
	
	if(flag == 'index') {
		$footer.children(".index").addClass("weui-bar__item_on");
		$footer.children(".index").find("img").attr("src","/usr/themes/wxui/img/icon/icon_index_active.png");
	} else if(flag == 'discover') {
		$footer.children(".discover").addClass("weui-bar__item_on");
		$footer.children(".discover").find("img").attr("src","/usr/themes/wxui/img/icon/icon_discover_active.png");
	} else if(flag == 'my') {
		$footer.children(".my").addClass("weui-bar__item_on");
		$footer.children(".my").find("img").attr("src","/usr/themes/wxui/img/icon/icon_my_active.png");
	} else if(flag == 'friends') {
		$footer.children(".friends").addClass("weui-bar__item_on");
		$footer.children(".friends").find("img").attr("src","/usr/themes/wxui/img/icon/icon_friends_active.png");
	}
});

//朋友圈首页小二点点击事件
$(".reply-hidden").on("click", function(e) {
	if ($(this).parent().hasClass("active")) {
		$(".reply-hidden").parent().removeClass("active");
	} else {
		$(".reply-hidden").parent().removeClass("active");
		$(this).parent().addClass("active")
	}
	$(document).on("click", function() {
		if ($(".reply-hidden").parent().hasClass("active")) {
			$(".reply-hidden").parent().removeClass("active");
		}
	})
	e.stopPropagation();
});

//点赞按钮点击事件
$(".btnFabulous").on("click", function() {
	showToast('点赞成功！', 'success-circle');
});


//评论按钮点击事件
function hide_dialog() {
	$('.weui-half-screen-dialog').css({
		"display": "none",
		"-webkit-transform": "translate(0,100%)",
		"transform": "translate(0,100%)"
	});
	$('.weui-mask').fadeOut(200);
};
$('.weui-mask').on('click', hide_dialog);
$('.weui-half-screen-dialog__ft').on('click', '.weui-btn', hide_dialog);
$('.weui-icon-close-thin').on('click', hide_dialog);

function btnComment(e) {
	$('.weui-half-screen-dialog').css({
		"display": "block",
		"-webkit-transform": "translate(0,0)",
		"transform": "translate(0,0)"
	});
	$('.weui-mask').fadeIn(200);
	
	var id = e.getAttribute("data-id");
	var coid = e.getAttribute("data-coid");
	var url = e.getAttribute("data-url");
	var author = e.getAttribute("data-author");
	$(".weui-half-screen-dialog .data-id").val(id);
	$(".weui-half-screen-dialog .data-coid").val(coid);
	$(".weui-half-screen-dialog .data-url").val(url);
	$(".weui-half-screen-dialog .data-pauthor").val(author);
	
	if(coid != null) {
	    console.log(coid);
	    $(".comment .weui-half-screen-dialog__title").text("回复 " + author);
	}
}

//发表评论按钮点击事件
function submitComment() {
	var form = {
		"author":$(".comment #author").val(),
		"text":$(".comment #text").val(),
		"cid":$(".comment .data-id").val(),
		"parent":$(".comment .data-coid").val(),
		"themeAction":"comment",
		"_":$(".comment .data-token").val(),
	}
	$.ajax({
		url: $(".comment .data-url").val(),
		type: 'POST',
		data: form,
		dataType: 'json',
		success: function(result){
			if(result.status == 0) {
				showToast(result.msg, 'warn');
			} else if(result.status == 1) {
				showToast("评论成功！", 'success');
				var $replyList = $(".data-" + $(".comment .data-id").val() + " .reply-list");
				if($(".comment .data-coid").val() != null && $(".comment .data-pauthor").val() != null) {
				    var replyInfo = '<span class="reply-info"><span class="nickname">' + result.comment.author + '</span> 回复 <span class="nickname">' + $(".comment .data-pauthor").val() + '</span> : <span>' + result.comment.content + '</span></span>';
				} else {
				    var replyInfo = '<span class="reply-info"><span class="nickname">' + result.comment.author + '</span> : <span>' + result.comment.content + '</span></span>';
				}
				
				if($replyList.length == 0) {
					$(".data-" + $(".comment .data-id").val() + " .share-bottom").after('<div class="reply-list">'+ replyInfo + '</div>');
				} else {
					$replyList.prepend(replyInfo);
				}
			} else {
				showToast("未知错误！", 'warn');
			}
		},
		error:function(e){
			showToast("未知错误！", 'warn');
		}
	});
	$(".comment #text").val("");
}

//评论内容字数统计事件
$(".comment .weui-textarea").bind("input propertychange",function(){
    var num = $(this).val().length;
	console.log(num);
	$(".comment #change_num").text(num);
});


//文章页面小三点操作按钮点击事件
function postMenu() {
    $('.weui-actionsheet').css({"display": "block"});
    $('.weui-actionsheet').addClass('weui-actionsheet_toggle');
	$('.weui-mask').fadeIn(200);
}

function hideActionSheet() {
    $('.weui-actionsheet').css({"display": "none"});
	$('.weui-actionsheet').removeClass('weui-actionsheet_toggle');
	$('.weui-mask').fadeOut(200);
};
$('.weui-mask').on('click', hideActionSheet);
$('#actionsheetCancel').on('click', hideActionSheet);
$('.weui-actionsheet__menu').on('click', '.weui-actionsheet__cell', hideActionSheet);

//朋友圈首页大图加载瀑布流功能
if($(".loading .weui-footer__text").html() == "") {
    $(".loading .weui-footer__text").html('加载到底了~')
}
$('.loading a.next').click(function() {
	$this = $(this);
	var href = $this.attr('href');
	if (href != undefined) {
		$this.addClass('loading').text('正在努力加载');
		$.ajax({
			url: href,
			type: 'get',
			error: function(request) {

			},
			success: function(data) {
				$this.removeClass('loading').text('点击查看更多');
				var $res = $(data).find('.dynamic-item');
				$('.dynamic').append($res.fadeIn(500));
				var newhref = $(data).find('a.next').attr('href');
				if (newhref != undefined) {
					$('a.next').attr('href', newhref);
				} else {
					$('a.next').text('加载到底了~');
					$('a.next').removeAttr("href");
				}
			}
		});
	}
	return false;
});

//首页文章点击进入详情页事件
$("#index .content .dynamic-content .dynamic-content-text").click(function(){
    var url = $(this).parent().data("url");
    console.log(url);
    location.href = url;
});
